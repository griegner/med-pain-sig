import pandas as pd


configfile: "config/smk-config.yml"


df = pd.read_csv("config/cbf-filtered.csv").query('task.str.endswith("49C")')


def hs_map_ns(wc):
    "create mapping between heat runs and corresponding neutral runs"
    wc.run = int(wc.run)
    runs = [wc.run]
    if wc.run % 2 == 0:
        runs.append(wc.run - 1)
    else:
        runs.append(wc.run + 1)
    return expand(
        config["aslprep"],
        run=runs,
    )


rule all:
    input:
        expand(
            config["cbf_to_ps"],
            zip,
            sub=df["sub"],
            ses=df["ses"],
            run=df["run"],
            task=df["task"],
        ),


rule cbf_to_ps:
    input:
        cmd="workflow/scripts/00_cbf-to-ps.py",
        path=hs_map_ns,
    output:
        config["cbf_to_ps"],
    params:
        smooth_fwhm=config["smooth_fwhm"],
    shell:
        "python {input.cmd} {input.path[0]} {input.path[1]} {output} --smooth_fwhm {params.smooth_fwhm}"
